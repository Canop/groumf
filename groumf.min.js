// Groumpf by denys.seguret@gmail.com
// https://github.com/Canop/groumf
(function(){function b(a){this.forest={},this.skippedTags={},this.dontCutWords=a&&a.dontCutWords!==undefined?a.dontCutWords:!0,this.skipTags("audio","img","svg","title","video")}var a=/[\d@A-Z_a-z~\xa1-\xac\xae-\xaf\xb5-\xba\xc0-\xfe\u0100-\u017F]/;b.prototype.skipTags=function(){for(var a=0;a<arguments.length;a++)this.skippedTags[arguments[a].toUpperCase()]=!0},b.prototype.dontSkipTags=function(){for(var a=0;a<arguments.length;a++)this.skippedTags[arguments[a].toUpperCase()]=!1},b.prototype.add=function(a,b){if(a.length<3)return console.log('Expression "'+a+'" ignored : too short');var c=a.slice(0,3).toLowerCase(),d=this.forest[c];d||(d=this.forest[c]=[]),d.push({p:a.toLowerCase(),v:b||a}),d.sort(function(a,b){return b.p.length-a.p.length})},b.prototype.get=function(a){var b=a.toLowerCase(),c=this.forest[b.slice(0,3)];if(!c)return;for(var d=0;d<c.length;d++)if(c[d].p===b)return c[d].v},b.prototype.replaceInString=function(b,c,d){if(d!==undefined)return b.replace(c,d);var e=b.length-2,f=[],g=0,h;for(var i=0;i<e;i++){if(this.dontCutWords&&i&&a.test(b[i-1]))continue;var j=b.slice(i,i+3).toLowerCase(),k=this.forest[j];if(!k)continue;for(var l=0;l<k.length;l++){var m=k[l].p;if(this.dontCutWords&&(h=b[i+m.length])&&a.test(h))continue;var n=b.slice(i,i+m.length);if(n.toLowerCase()===m){var o=c?c(n,k[l].v):k[l].v;i&&f.push(b.slice(g,i)),f.push(o),i+=m.length,g=i;break}}}return f.push(b.slice(g,b.length)),f.join("")},b.prototype.replaceTextWithTextInHTML=function(a,b,c){var d=a.childNodes;for(var e=d.length;e--;){var f=d[e];f.nodeType===3?f.nodeValue=this.replaceInString(f.nodeValue,b,c):this.skippedTags[f.tagName]||this.replaceTextWithTextInHTML(f,b,c)}return a},b.prototype.replaceTextWithHTMLInHTMLUsingRegex=function(a,b,c){var d=[].slice.call(a.childNodes);for(var e=d.length;e--;){var f=d[e];if(f.nodeType===3){var g=f.nodeValue,h=0,i;while(i=b.exec(g)){i.index&&a.insertBefore(document.createTextNode(g.slice(h,i.index)),f);var j=c.apply(null,i.concat(i.index,i.input)),k=document.createElement("div");k.innerHTML=j;var l;while(l=k.firstChild)a.insertBefore(l,f);h=i.index+i[0].length;if(!b.global)break}h&&(a.insertBefore(document.createTextNode(g.slice(h,g.length)),f),a.removeChild(f))}else this.skippedTags[f.tagName]||this.replaceTextWithHTMLInHTMLUsingRegex(f,b,c)}return a},b.prototype.replaceTextWithHTMLInHTML=function(b,c,d){if(d)return this.replaceTextWithHTMLInHTMLUsingRegex(b,c,d);var e=[].slice.call(b.childNodes);for(var f=e.length;f--;){var g=e[f];if(g.nodeType===3){var h=g.nodeValue,i=h.length-2,j=0,k;for(var l=0;l<i;l++){if(this.dontCutWords&&l&&a.test(h[l-1]))continue;var m=h.slice(l,l+3).toLowerCase(),n=this.forest[m];if(!n)continue;for(var o=0;o<n.length;o++){var p=n[o].p;if(this.dontCutWords&&(k=h[l+p.length])&&a.test(k))continue;var q=h.slice(l,l+p.length);if(q.toLowerCase()===p){l&&b.insertBefore(document.createTextNode(h.slice(j,l)),g);var r=c?c(q,n[o].v):n[o].v,s=document.createElement("div");s.innerHTML=r;for(var t=0,u=s.childNodes,v=u.length;t<v;t++)b.insertBefore(u[t],g);l+=p.length,j=l;break}}}j&&(b.insertBefore(document.createTextNode(h.slice(j,h.length)),g),b.removeChild(g))}else this.skippedTags[g.tagName]||this.replaceTextWithHTMLInHTML(g,c)}return b},b.prototype.replace=function(a,b,c){var d=a.childNodes;return d?this.replaceTextWithTextInHTML(a,b,c):this.replaceInString(a,b,c)},["replace","replaceTextWithHTMLInHTML","replaceTextWithHTMLInHTMLUsingRegex","replaceTextWithTextInHTML","replaceInString"].forEach(function(a){b[a]=function(){return b.prototype[a].apply(new b,arguments)}}),typeof module!="undefined"?module.exports=b:window&&(window.Groumf=b)})();